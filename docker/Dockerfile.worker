FROM docker.io/library/r-base:4.5.1

RUN apt-get update && \
    apt-get install -y --allow-downgrades libdatrie1:amd64=0.2.13-3+b1 && \
    apt-get install --no-install-recommends -y python3 python3-pip python3-dev \ 
                                               libcurl4-openssl-dev libxml2-dev libssl-dev libmagick++-dev && \
    rm -rf /var/lib/apt/lists/* && \
    mkdir /data && \
    apt-get clean && \
# install heavy python libraries using pip
    rm /usr/lib/python3.13/EXTERNALLY-MANAGED && \
    pip3 --cache-dir /tmp/pip_cache install redis pika rpy2 statsmodels scipy

# Copy the script required to install the R packages
COPY install_libraries.R /tmp/

# Install the R libraries
RUN R --vanilla < /tmp/install_libraries.R

# Copy our python packages
COPY reactome_analysis_utils-*.whl /tmp/
COPY reactome_analysis_api-*.whl /tmp/
COPY reactome_analysis_worker-*.whl /tmp/

# install the python packages and create the /data directory
RUN pip3 --cache-dir /tmp/pip_cache install setuptools && \
    pip3 --cache-dir /tmp/pip_cache install wheel && \
    pip3 --cache-dir /tmp/pip_cache install /tmp/reactome_analysis_utils-*.whl && \
    pip3 --cache-dir /tmp/pip_cache install /tmp/reactome_analysis_api-*.whl && \
    pip3 --cache-dir /tmp/pip_cache install /tmp/reactome_analysis_worker-*.whl && \
    # cleanup
    pip3 --cache-dir /tmp/pip_cache uninstall -y setuptools && \
    rm -rf /tmp/*

# environment variables that govern some functionality of the image
ENV REACTOME_STORAGE_PATH /data
ENV REACTOME_SOURCE /data
ENV REACTOME_INTERACTOR_FILE /data/interactors.txt
ENV REACTOME_VERSION 93

# Copy the REACTOME related pathway files
COPY IntAct_Static.txt /data/interactors.txt
COPY UniProt2Reactome_All_Levels.txt /data/
COPY Ensembl2Reactome_All_Levels.txt /data/

# create the gene sets
RUN python3 -m reactome_analysis_worker.geneset_builder

CMD ["python3", "-m", "reactome_analysis_worker"]
